import e from"jquery";import t from"@typo3/backend/modal.js";import a from"@typo3/core/ajax/ajax-request.js";import s from"@typo3/backend/severity.js";const n=new class{constructor(){this.bindListener()}bindListener(){e(".content-type-switches a").on("click",this.onContentTypeSwitchClick.bind(this)),e("button[data-delete]").on("click",this.onDeleteButtonClick.bind(this)),e("#delete-all-messages").on("click",this.onDeleteAllMessagesClick.bind(this)),e(".panel").on("click",this.onPanelClick.bind(this))}onPanelClick(t){const a="true"===e(t.currentTarget).attr("data-html-loaded");if(e('.content-type-switches a[data-content-type="html"]:first-child',t.currentTarget).length&&!a){const a=e(t.currentTarget).attr("data-message-file");this.loadHtmlMail(a)}}onDeleteAllMessagesClick(e){e.preventDefault();const a=this;t.confirm("Delete Messages","Are you sure, you want to delete all messages?",s.warning,[{text:"Yes, delete",btnClass:"btn-danger",trigger:function(){a.deleteAllMessages(),t.dismiss()}},{text:"No, abort",btnClass:"primary-outline",active:!0,trigger:function(){t.dismiss()}}])}deleteAllMessages(){const t=this,s=e(".panel[data-message-file]");new a(TYPO3.settings.ajaxUrls.mailcatcher_delete_all).get().then((async function(e){if((await e.resolve()).success)return s.remove(),t.refreshMessageCount(),void top.TYPO3.Notification.success("Success","All messages have been deleted",3);top.TYPO3.Notification.error("Error","Could not delete messages",3)}))}refreshMessageCount(){const t=e(".panel[data-message-file]").length;e("*[data-message-count]").attr("data-message-count",t),e(".message-count").html(t.toString())}onDeleteButtonClick(t){t.preventDefault();const s=e(t.currentTarget).closest(".panel"),n=s.attr("data-message-file"),l=this;new a(TYPO3.settings.ajaxUrls.mailcatcher_delete).withQueryArguments({messageFile:n}).get().then((async function(e){if((await e.resolve()).success)return s.remove(),void l.refreshMessageCount();top.TYPO3.Notification.error("Error","Could not delete message",3)}))}onContentTypeSwitchClick(t){t.preventDefault();const a=e(t.currentTarget).attr("data-content-type"),s=e(t.currentTarget).attr("data-m-id");e('.content-type-switches a[data-m-id="'+s+'"]').addClass("btn-default").removeClass("btn-primary"),e('.content-type-switches a[data-m-id="'+s+'"][data-content-type="'+a+'"]').removeClass("btn-default").addClass("btn-primary"),e('.form-section[data-m-id="'+s+'"]').addClass("hidden");e('.form-section[data-m-id="'+s+'"][data-content-type="'+a+'"]').removeClass("hidden");const n=e(t.currentTarget).closest(".panel");"false"===n.attr("data-html-loaded")&&"html"===a&&this.loadHtmlMail(n.attr("data-message-file"))}loadHtmlMail(t){new a(TYPO3.settings.ajaxUrls.mailcatcher_html).withQueryArguments({messageFile:t}).get().then((async function(a){const s=await a.resolve(),n=e("<iframe />").attr("width","100%").attr("frameBorder","0").attr("height","668px").attr("srcdoc",s.src);e('.panel[data-message-file="'+t+'"] .form-section[data-content-type="html"]').html(n),e('.panel[data-message-file="'+t+'"]').attr("data-html-loaded","true")})).catch((()=>{e('.panel[data-message-file="'+t+'"] .form-section[data-content-type="html"]').html('<div class="callout callout-danger">Could not load message</div>')}))}};export{n as XmMailCatcher};
