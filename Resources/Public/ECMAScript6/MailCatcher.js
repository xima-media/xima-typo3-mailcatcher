import t from"jquery";import e from"@typo3/backend/modal.js";import a from"@typo3/core/ajax/ajax-request.js";import s from"@typo3/backend/severity.js";const n=new class{constructor(){this.bindListener()}bindListener(){t(".content-type-switches a").on("click",this.onContentTypeSwitchClick.bind(this)),t("button[data-delete]").on("click",this.onDeleteButtonClick.bind(this)),t("#delete-all-messages").on("click",this.onDeleteAllMessagesClick.bind(this)),t(".panel").on("click",this.onPanelClick.bind(this))}onPanelClick(e){const a="true"===t(e.currentTarget).attr("data-html-loaded");if(t('.content-type-switches a[data-content-type="html"]:first-child',e.currentTarget).length&&!a){const a=t(e.currentTarget).attr("data-message-file");this.loadHtmlMail(a)}}onDeleteAllMessagesClick(t){t.preventDefault();const a=this;e.confirm(TYPO3.lang["js.delete.button"],TYPO3.lang["js.delete.message"],s.warning,[{text:TYPO3.lang["js.delete.yes"],btnClass:"btn-danger",trigger:function(){a.deleteAllMessages(),e.dismiss()}},{text:TYPO3.lang["js.delete.no"],btnClass:"btn-default",active:!0,trigger:function(){e.dismiss()}}])}deleteAllMessages(){const e=this,s=t(".panel[data-message-file]");new a(TYPO3.settings.ajaxUrls.mailcatcher_delete_all).get().then((async function(t){if((await t.resolve()).success)return s.remove(),e.refreshMessageCount(),void top.TYPO3.Notification.success(TYPO3.lang["js.success.headline"],TYPO3.lang["js.success.text"],3);top.TYPO3.Notification.error(TYPO3.lang["js.error.headline"],TYPO3.lang["js.error.text"],3)}))}refreshMessageCount(){const e=t(".panel[data-message-file]").length;t("*[data-message-count]").attr("data-message-count",e),t(".message-count").html(e.toString())}onDeleteButtonClick(e){e.preventDefault();const s=t(e.currentTarget).closest(".panel"),n=s.attr("data-message-file"),l=this;new a(TYPO3.settings.ajaxUrls.mailcatcher_delete).withQueryArguments({messageFile:n}).get().then((async function(t){if((await t.resolve()).success)return s.remove(),l.refreshMessageCount(),void top.TYPO3.Notification.success(TYPO3.lang["js.success.headline"],TYPO3.lang["js.success.text2"],3);top.TYPO3.Notification.error(TYPO3.lang["js.error.headline"],TYPO3.lang["js.error.text2"],3)}))}onContentTypeSwitchClick(e){e.preventDefault();const a=t(e.currentTarget).attr("data-content-type"),s=t(e.currentTarget).attr("data-m-id");t('.content-type-switches a[data-m-id="'+s+'"]').addClass("btn-default").removeClass("btn-primary"),t('.content-type-switches a[data-m-id="'+s+'"][data-content-type="'+a+'"]').removeClass("btn-default").addClass("btn-primary"),t('.form-section[data-m-id="'+s+'"]').addClass("hidden");t('.form-section[data-m-id="'+s+'"][data-content-type="'+a+'"]').removeClass("hidden");const n=t(e.currentTarget).closest(".panel");"false"===n.attr("data-html-loaded")&&"html"===a&&this.loadHtmlMail(n.attr("data-message-file"))}loadHtmlMail(e){new a(TYPO3.settings.ajaxUrls.mailcatcher_html).withQueryArguments({messageFile:e}).get().then((async function(a){const s=await a.resolve(),n=t("<iframe />").attr("width","100%").attr("frameBorder","0").attr("height","668px").attr("srcdoc",s.src);t('.panel[data-message-file="'+e+'"] .form-section[data-content-type="html"]').html(n),t('.panel[data-message-file="'+e+'"]').attr("data-html-loaded","true")})).catch((()=>{t('.panel[data-message-file="'+e+'"] .form-section[data-content-type="html"]').html('<div class="callout callout-danger">'+TYPO3.lang["js.error.text3"]+"</div>")}))}};export{n as XmMailCatcher};
